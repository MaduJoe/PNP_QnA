{% extends "base.html" %}

{% block title %}ëŒ€ì‹œë³´ë“œ - PNP QnA Bot{% endblock %}

{% block content %}
<div class="row">
    <!-- ì‹¤ì‹œê°„ í†µê³„ ì¹´ë“œë“¤ -->
    <div class="col-md-3 mb-4">
        <div class="card stat-card">
            <div class="card-body text-center">
                <div class="stat-number" id="total-queries">-</div>
                <div class="stat-label">ì´ ì§ˆì˜ ìˆ˜</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card stat-card success">
            <div class="card-body text-center">
                <div class="stat-number" id="unique-users">-</div>
                <div class="stat-label">ê³ ìœ  ì‚¬ìš©ì</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card stat-card warning">
            <div class="card-body text-center">
                <div class="stat-number" id="avg-response-time">-</div>
                <div class="stat-label">í‰ê·  ì‘ë‹µì‹œê°„</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card stat-card info">
            <div class="card-body text-center">
                <div class="stat-number" id="recent-queries">-</div>
                <div class="stat-label">ìµœê·¼ 1ì‹œê°„</div>
            </div>
        </div>
    </div>
</div>

<!-- ê¸°ê°„ ì„ íƒ ë° ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>ë¶„ì„ ê¸°ê°„
                    </h5>
                    <div class="d-flex gap-2">
                        <select id="period-selector" class="form-select" style="width: auto;">
                            <option value="1">ìµœê·¼ 1ì¼</option>
                            <option value="7" selected>ìµœê·¼ 7ì¼</option>
                            <option value="30">ìµœê·¼ 30ì¼</option>
                            <option value="90">ìµœê·¼ 90ì¼</option>
                        </select>
                        <button id="refresh-btn" class="btn btn-outline-primary btn-custom">
                            <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
                        </button>
                        <button id="export-btn" class="btn btn-success btn-custom">
                            <i class="fas fa-download"></i> CSV ë‚´ë³´ë‚´ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- ì‹œê°„ëŒ€ë³„ ì§ˆì˜ íŒ¨í„´ ì°¨íŠ¸ -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clock me-2"></i>ì‹œê°„ëŒ€ë³„ ì§ˆì˜ íŒ¨í„´
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="hourly-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ì¼ë³„ ì§ˆì˜ ì¶”ì´ ì°¨íŠ¸ -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-calendar me-2"></i>ì¼ë³„ ì§ˆì˜ ì¶”ì´
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="daily-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- ì¹´í…Œê³ ë¦¬ë³„ í†µê³„ -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tags me-2"></i>ì¹´í…Œê³ ë¦¬ë³„ í†µê³„
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <div class="h4 text-primary" id="product-results">-</div>
                            <div class="text-muted small">ğŸ’» Product QnA</div>
                            <div class="text-muted small" id="product-avg-time">í‰ê· : -</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="h4 text-success" id="bugs-results">-</div>
                        <div class="text-muted small">ğŸ› Bugs QnA</div>
                        <div class="text-muted small" id="bugs-avg-time">í‰ê· : -</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ì¸ê¸° í‚¤ì›Œë“œ -->
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-fire me-2"></i>ì¸ê¸° ì§ˆì˜ í‚¤ì›Œë“œ
                </h5>
            </div>
            <div class="card-body">
                <div id="popular-queries" class="d-flex flex-wrap gap-2">
                    <!-- í‚¤ì›Œë“œ ë°°ì§€ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ìµœê·¼ ì§ˆì˜ ëª©ë¡ -->
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>ìµœê·¼ ì§ˆì˜
                </h5>
                <a href="/queries" class="btn btn-outline-primary btn-sm btn-custom">
                    ì „ì²´ ë³´ê¸°
                </a>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ì‹œê°„</th>
                                <th>ì‚¬ìš©ì</th>
                                <th>ì§ˆì˜ ë‚´ìš©</th>
                                <th>ê²°ê³¼</th>
                                <th>ì‘ë‹µì‹œê°„</th>
                            </tr>
                        </thead>
                        <tbody id="recent-queries-table">
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    <div class="loading"></div> ë°ì´í„° ë¡œë”© ì¤‘...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let hourlyChart, dailyChart;
let currentPeriod = 7;

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    loadDashboardData();
    loadRecentQueries();
    
    // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (30ì´ˆë§ˆë‹¤)
    setInterval(loadLiveStats, 30000);
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('period-selector').addEventListener('change', function() {
        currentPeriod = parseInt(this.value);
        loadDashboardData();
    });
    
    document.getElementById('refresh-btn').addEventListener('click', function() {
        this.innerHTML = '<div class="loading"></div>';
        loadDashboardData();
        loadRecentQueries();
        setTimeout(() => {
            this.innerHTML = '<i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨';
        }, 1000);
    });
    
    document.getElementById('export-btn').addEventListener('click', exportToCSV);
});

function initCharts() {
    // ì‹œê°„ëŒ€ë³„ ì°¨íŠ¸
    const hourlyCtx = document.getElementById('hourly-chart').getContext('2d');
    hourlyChart = new Chart(hourlyCtx, {
        type: 'bar',
        data: {
            labels: Array.from({length: 24}, (_, i) => `${i}ì‹œ`),
            datasets: [{
                label: 'ì§ˆì˜ ìˆ˜',
                data: new Array(24).fill(0),
                backgroundColor: 'rgba(37, 99, 235, 0.8)',
                borderColor: 'rgba(37, 99, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
    
    // ì¼ë³„ ì°¨íŠ¸
    const dailyCtx = document.getElementById('daily-chart').getContext('2d');
    dailyChart = new Chart(dailyCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'ì§ˆì˜ ìˆ˜',
                data: [],
                borderColor: 'rgba(5, 150, 105, 1)',
                backgroundColor: 'rgba(5, 150, 105, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
}

function loadDashboardData() {
    fetch(`/api/stats?days=${currentPeriod}`)
        .then(response => response.json())
        .then(data => {
            updateStats(data);
            updateCharts(data);
            updatePopularQueries(data.popular_queries || []);
        })
        .catch(error => {
            console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            showToast('ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
        });
}

function loadRecentQueries() {
    fetch('/api/recent_queries?limit=10')
        .then(response => response.json())
        .then(data => {
            updateRecentQueriesTable(data);
        })
        .catch(error => {
            console.error('ìµœê·¼ ì§ˆì˜ ë¡œë“œ ì‹¤íŒ¨:', error);
        });
}

function loadLiveStats() {
    fetch('/api/live_stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('recent-queries').textContent = formatNumber(data.recent_1hour);
        })
        .catch(error => {
            console.error('ì‹¤ì‹œê°„ í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
        });
}

function updateStats(data) {
    document.getElementById('total-queries').textContent = formatNumber(data.total_queries);
    document.getElementById('unique-users').textContent = formatNumber(data.unique_users);
    document.getElementById('avg-response-time').textContent = formatTime(data.avg_response_time_ms);
    
    // ì¹´í…Œê³ ë¦¬ë³„ í†µê³„
    const categoryStats = data.category_stats || {};
    document.getElementById('product-results').textContent = formatNumber(categoryStats.total_product_results || 0);
    document.getElementById('bugs-results').textContent = formatNumber(categoryStats.total_bugs_results || 0);
    document.getElementById('product-avg-time').textContent = `í‰ê· : ${formatTime(categoryStats.avg_product_response_time || 0)}`;
    document.getElementById('bugs-avg-time').textContent = `í‰ê· : ${formatTime(categoryStats.avg_bugs_response_time || 0)}`;
}

function updateCharts(data) {
    // ì‹œê°„ëŒ€ë³„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    if (data.hourly_data) {
        const hourlyData = Object.values(data.hourly_data);
        hourlyChart.data.datasets[0].data = hourlyData;
        hourlyChart.update();
    }
    
    // ì¼ë³„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    if (data.daily_data) {
        const labels = data.daily_data.map(item => new Date(item[0]).toLocaleDateString('ko-KR'));
        const values = data.daily_data.map(item => item[1]);
        
        dailyChart.data.labels = labels;
        dailyChart.data.datasets[0].data = values;
        dailyChart.update();
    }
}

function updatePopularQueries(queries) {
    const container = document.getElementById('popular-queries');
    container.innerHTML = '';
    
    if (queries.length === 0) {
        container.innerHTML = '<span class="text-muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
        return;
    }
    
    queries.forEach((query, index) => {
        const badge = document.createElement('span');
        badge.className = `badge bg-primary badge-custom`;
        badge.textContent = `${query.query} (${query.count})`;
        badge.style.fontSize = `${Math.max(0.8, 1.2 - index * 0.1)}rem`;
        container.appendChild(badge);
    });
}

function updateRecentQueriesTable(queries) {
    const tbody = document.getElementById('recent-queries-table');
    tbody.innerHTML = '';
    
    if (queries.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ì§ˆì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }
    
    queries.forEach(query => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${formatDate(query.timestamp)}</td>
            <td><span class="badge bg-secondary">${query.user_id.substring(0, 8)}...</span></td>
            <td>
                <button type="button" class="btn btn-link text-start p-0 text-decoration-none" 
                        onclick="showQueryDetail(${query.id})">
                    ${query.query_text.length > 30 ? query.query_text.substring(0, 30) + '...' : query.query_text}
                </button>
            </td>
            <td>
                <span class="badge bg-info">${query.product_results_count || 0}</span>
                <span class="badge bg-success">${query.bugs_results_count || 0}</span>
            </td>
            <td>${formatTime(query.response_time_ms || 0)}</td>
        `;
        tbody.appendChild(row);
    });
}

function exportToCSV() {
    const days = currentPeriod;
    window.location.href = `/api/export_csv?days=${days}`;
    showToast('CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.', 'success');
}

function showQueryDetail(queryId) {
    // ëª¨ë‹¬ í‘œì‹œ
    const modal = new bootstrap.Modal(document.getElementById('queryDetailModal'));
    modal.show();
    
    // ë¡œë”© ìƒíƒœ í‘œì‹œ
    document.getElementById('modalQueryText').innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><span class="ms-2">ë¡œë”© ì¤‘...</span></div>';
    document.getElementById('modalResults').innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
    
    // API í˜¸ì¶œ
    fetch(`/api/query_detail/${queryId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showToast('ì§ˆì˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
                return;
            }
            
            updateModalContent(data);
        })
        .catch(error => {
            console.error('ì§ˆì˜ ìƒì„¸ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            showToast('ì§ˆì˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
        });
}

function updateModalContent(query) {
    // ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸
    document.getElementById('modalQueryText').innerHTML = `
        <div class="card">
            <div class="card-body">
                <h6 class="card-title text-primary">ì§ˆì˜ ë‚´ìš©</h6>
                <p class="card-text">${query.query_text}</p>
                <small class="text-muted">
                    <i class="fas fa-clock me-1"></i>${formatDate(query.timestamp)} | 
                    <i class="fas fa-user me-1"></i>${query.user_id} | 
                    <i class="fas fa-tachometer-alt me-1"></i>${formatTime(query.response_time_ms || 0)}
                </small>
            </div>
        </div>
    `;
    
    // ê²€ìƒ‰ ê²°ê³¼ ì—…ë°ì´íŠ¸
    let resultsHtml = '';
    
    // Product QnA ê²°ê³¼
    if (query.product_results && query.product_results.length > 0) {
        resultsHtml += `
            <div class="mb-4">
                <h6 class="text-primary"><i class="fas fa-coffee me-2"></i>Product QnA ê²°ê³¼ (${query.product_results.length}ê°œ)</h6>
                <div class="list-group">
        `;
        
        query.product_results.forEach((result, index) => {
            resultsHtml += `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${result.title}</h6>
                        <small class="text-muted">ì ìˆ˜: ${(result.combined_score * 100).toFixed(1)}%</small>
                    </div>
                    <p class="mb-1 small text-muted">${result.category}</p>
                    <small><a href="${result.url}" target="_blank" class="text-decoration-none">ë§í¬ ì—´ê¸° <i class="fas fa-external-link-alt"></i></a></small>
                </div>
            `;
        });
        
        resultsHtml += '</div></div>';
    }
    
    // Bugs QnA ê²°ê³¼
    if (query.bugs_results && query.bugs_results.length > 0) {
        resultsHtml += `
            <div class="mb-4">
                <h6 class="text-success"><i class="fas fa-bug me-2"></i>Bugs QnA ê²°ê³¼ (${query.bugs_results.length}ê°œ)</h6>
                <div class="list-group">
        `;
        
        query.bugs_results.forEach((result, index) => {
            resultsHtml += `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${result.title}</h6>
                        <small class="text-muted">ì ìˆ˜: ${(result.combined_score * 100).toFixed(1)}%</small>
                    </div>
                    <p class="mb-1 small text-muted">${result.category}</p>
                    <small><a href="${result.url}" target="_blank" class="text-decoration-none">ë§í¬ ì—´ê¸° <i class="fas fa-external-link-alt"></i></a></small>
                </div>
            `;
        });
        
        resultsHtml += '</div></div>';
    }
    
    if (!resultsHtml) {
        resultsHtml = '<div class="text-center text-muted"><i class="fas fa-info-circle me-2"></i>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
    
    document.getElementById('modalResults').innerHTML = resultsHtml;
}
</script>

<!-- ì§ˆì˜ ìƒì„¸ì •ë³´ ëª¨ë‹¬ -->
<div class="modal fade" id="queryDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>ì§ˆì˜ ìƒì„¸ì •ë³´
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="modalQueryText" class="mb-4">
                    <!-- ì§ˆì˜ ì •ë³´ê°€ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
                </div>
                
                <div id="modalResults">
                    <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>ë‹«ê¸°
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %} 